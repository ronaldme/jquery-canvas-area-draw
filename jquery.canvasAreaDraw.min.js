!function(a){a.fn.canvasAreaDraw=function(a){this.each(function(c,d){b.apply(d,[c,d,a])})};var b=function(b,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=!1;h=a.extend({imageUrl:a(this).attr("data-image-url")},e),f=[],j=a("#canvas-area"),k=j[0].getContext("2d"),l=new Image,s=function(a,b){j.attr("width",a).attr("height",b),m()},l.src=h.imageUrl+"?"+(new Date).getTime(),j.css({background:"url("+l.src+")  0% 0% / 100%"}),t=function(){f=[],m()},p=function(b){b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top),f[g]=Math.round(b.offsetX),f[g+1]=Math.round(b.offsetY),m()},r=function(b){b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top),w||(w={x:Math.round(b.offsetX),y:Math.round(b.offsetY)});for(var c={x:Math.round(b.offsetX),y:Math.round(b.offsetY)},d=0;d<f.length;d++)f[d]=c.x-w.x+f[d],f[++d]=c.y-w.y+f[d];w=c,m()},o=function(){a(this).off("mousemove"),v(),g=null},u=function(b){b.preventDefault(),b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top);for(var c=b.offsetX,d=b.offsetY,e=0;e<f.length;e+=2)if(dis=Math.sqrt(Math.pow(c-f[e],2)+Math.pow(d-f[e+1],2)),dis<6)return f.splice(e,2),m(),v(),!1;return!1},n=function(b){var d,e,h,i,j=f.length;if(3===b.which)return!1;if(b.preventDefault(),b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top),d=b.offsetX,e=b.offsetY,f.length>=6){var l=q();if(k.fillRect(l.x-4,l.y-4,8,8),h=Math.sqrt(Math.pow(d-l.x,2)+Math.pow(e-l.y,2)),h<6)return w=!1,a(this).on("mousemove",r),!1}for(var n=0;n<f.length;n+=2)if(h=Math.sqrt(Math.pow(d-f[n],2)+Math.pow(e-f[n+1],2)),h<6)return g=n,a(this).on("mousemove",p),!1;for(var n=0;n<f.length;n+=2)n>1&&(i=c(d,e,f[n],f[n+1],f[n-2],f[n-1],!0),i<6&&(j=n));return f.splice(j,0,Math.round(d),Math.round(e)),g=j,a(this).on("mousemove",p),m(),v(),!1},m=function(){if(k.canvas.width=k.canvas.width,v(),!(f.length<2)){if(k.globalCompositeOperation="destination-over",k.fillStyle="rgb(255,255,255)",k.strokeStyle="rgb(255,255,0)",k.lineWidth=1,f.length>=6){var a=q();k.fillRect(a.x-4,a.y-4,8,8)}k.beginPath(),k.moveTo(f[0],f[1]);for(var b=0;b<f.length;b+=2)k.fillRect(f[b]-2,f[b+1]-2,4,4),k.strokeRect(f[b]-2,f[b+1]-2,4,4),f.length>2&&b>1&&k.lineTo(f[b],f[b+1]);k.closePath(),k.fillStyle="rgba(255,0,0,0.3)",k.fill(),k.stroke()}},v=function(){a(d).val(f.join(","))},q=function(){var a=[];for(l=0;l<f.length;l++)a.push({x:f[l],y:f[++l]});var b=a[0],c=a[a.length-1];b.x==c.x&&b.y==c.y||a.push(b);for(var i,j,k,d=0,e=0,g=0,h=a.length,l=0,m=h-1;l<h;m=l++)i=a[l],j=a[m],k=i.x*j.y-j.x*i.y,d+=k,e+=(i.x+j.x)*k,g+=(i.y+j.y)*k;return k=3*d,{x:e/k,y:g/k}},a(d).on("change",function(){var b=a(d).val().replace(/[^0-9\,]/gi,"");f=b.length?b.split(",").map(function(a){return parseInt(a,10)}):[],m()}),a(document).find(i).click(t),a(document).find(j).on("mousedown",n),a(document).find(j).on("contextmenu",u),a(document).find(j).on("mouseup",o),a(d).after("<br>",j,"<br>",i),s(e.width,e.height)};a(document).ready(function(){a(".canvas-area[data-image-url]").canvasAreaDraw()});var c=function(a,b,c,d,e,f,g){function h(a,b,c,d){return Math.sqrt((a-=c)*a+(b-=d)*b)}if(!g||(g=function(a,b,c,d,e,f){if(!(e-c))return{x:c,y:b};if(!(f-d))return{x:a,y:d};var g,h=-1/((f-d)/(e-c));return{x:g=(e*(a*h-b+d)+c*(a*-h+b-f))/(h*(e-c)+d-f),y:h*g-h*a+b}}(a,b,c,d,e,f),g.x>=Math.min(c,e)&&g.x<=Math.max(c,e)&&g.y>=Math.min(d,f)&&g.y<=Math.max(d,f))){var k=d-f,l=e-c,m=c*f-d*e;return Math.abs(k*a+l*b+m)/Math.sqrt(k*k+l*l)}var i=h(a,b,c,d),j=h(a,b,e,f);return i>j?j:i}}(jQuery);